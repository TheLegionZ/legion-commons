package br.com.thelegion.legioncommons.fixes;

import com.comphenix.protocol.PacketType;
import com.comphenix.protocol.events.*;
import org.bukkit.plugin.Plugin;

import java.util.Collections;
import java.util.List;
import java.util.Locale;

import static com.comphenix.protocol.PacketType.Play.Client.CHAT;

public class Log4jExploitFixListener extends PacketAdapter {

    private static final List<PacketType> TYPES = Collections.singletonList(CHAT);

    public Log4jExploitFixListener(Plugin plugin) {
        super(plugin, ListenerPriority.LOWEST, TYPES, ListenerOptions.ASYNC);
    }

    @Override
    public void onPacketReceiving(PacketEvent event) {
        if (!TYPES.contains(event.getPacketType())) {
            return;
        }

        PacketContainer packetContainer = event.getPacket();
        String message = packetContainer.getStrings().read(0).toLowerCase(Locale.ROOT);

        if (message.contains("${jndi:")) {
            event.setCancelled(true);
        }
    }
}
